---
import { ViewTransitions } from 'astro:transitions';
import { getRelativeLocaleUrl } from 'astro:i18n';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getLangFromUrl } from '../i18n/utils';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  preloadImage?: string;
}

const {
  title,
  description = "Automatisera löneberäkningar för ditt taxiåkeri. Stöd för Uber, Bolt, Taxi Stockholm. Börja gratis.",
  preloadImage
} = Astro.props;

// Get current language from URL
const lang = getLangFromUrl(Astro.url);

// Generate hreflang URLs
const currentPath = Astro.url.pathname
  .replace(/^\/(en|sv)\//, '/')
  .replace(/^\/(en|sv)$/, '/');
const svUrl = getRelativeLocaleUrl('sv', currentPath === '/' ? '' : currentPath);
const enUrl = getRelativeLocaleUrl('en', currentPath === '/' ? '' : currentPath);
const arUrl = getRelativeLocaleUrl('ar', currentPath === '/' ? '' : currentPath);
const faUrl = getRelativeLocaleUrl('fa', currentPath === '/' ? '' : currentPath);
const soUrl = getRelativeLocaleUrl('so', currentPath === '/' ? '' : currentPath);

// Determine RTL direction
const isRtl = lang === 'ar' || lang === 'fa';

// Get locale for structured data
const localeMap: Record<string, string> = {
  'sv': 'sv-SE',
  'en': 'en-US',
  'ar': 'ar-SA',
  'fa': 'fa-IR',
  'so': 'so-SO'
};
const currentLocale = localeMap[lang] || 'sv-SE';
---

<!doctype html>
<html lang={lang} dir={lang === 'ar' || lang === 'fa' ? 'rtl' : 'ltr'}>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <link rel="canonical" href={Astro.url.href} />

    <!-- Hreflang tags for SEO -->
    <link rel="alternate" hreflang="sv-SE" href={`https://taxiadministration.se${svUrl}`} />
    <link rel="alternate" hreflang="en-US" href={`https://taxiadministration.se${enUrl}`} />
    <link rel="alternate" hreflang="ar-SA" href={`https://taxiadministration.se${arUrl}`} />
    <link rel="alternate" hreflang="fa-IR" href={`https://taxiadministration.se${faUrl}`} />
    <link rel="alternate" hreflang="so-SO" href={`https://taxiadministration.se${soUrl}`} />
    <link rel="alternate" hreflang="x-default" href={`https://taxiadministration.se${svUrl}`} />

    <ViewTransitions />

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H05H72ZJCF"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-H05H72ZJCF', {
        'linker': {
          'domains': ['taxiadministration.se', 'app.taxiadministration.se']
        }
      });

      // Web Vitals reporting to GA4
      function sendToGoogleAnalytics({name, delta, id}) {
        gtag('event', name, {
          event_category: 'Web Vitals',
          event_label: id,
          value: Math.round(name === 'CLS' ? delta * 1000 : delta),
          non_interaction: true,
        });
      }

      // Measure Core Web Vitals
      if ('PerformanceObserver' in window) {
        // Largest Contentful Paint
        try {
          new PerformanceObserver((entryList) => {
            const entries = entryList.getEntries();
            const lastEntry = entries[entries.length - 1];
            sendToGoogleAnalytics({name: 'LCP', delta: lastEntry.startTime, id: 'lcp-' + Date.now()});
          }).observe({type: 'largest-contentful-paint', buffered: true});
        } catch (e) {}

        // First Input Delay / Interaction to Next Paint
        try {
          new PerformanceObserver((entryList) => {
            const entries = entryList.getEntries();
            entries.forEach(entry => {
              sendToGoogleAnalytics({name: 'INP', delta: entry.duration, id: 'inp-' + Date.now()});
            });
          }).observe({type: 'first-input', buffered: true});
        } catch (e) {}

        // Cumulative Layout Shift
        try {
          let clsValue = 0;
          new PerformanceObserver((entryList) => {
            for (const entry of entryList.getEntries()) {
              if (!entry.hadRecentInput) {
                clsValue += entry.value;
              }
            }
          }).observe({type: 'layout-shift', buffered: true});

          // Report CLS on page hide
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
              sendToGoogleAnalytics({name: 'CLS', delta: clsValue, id: 'cls-' + Date.now()});
            }
          });
        } catch (e) {}
      }
    </script>

    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    {preloadImage && <link rel="preload" as="image" href={preloadImage} />}

    <!-- Structured data -->
    <script type="application/ld+json" set:html={`{
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "Organization",
          "@id": "https://taxiadministration.se/#organization",
          "name": "Baerell AB",
          "url": "https://taxiadministration.se",
          "logo": {
            "@type": "ImageObject",
            "url": "https://taxiadministration.se/logo.png",
            "width": 200,
            "height": 60
          },
          "description": "Utvecklar digitala lösningar för svensk taxi- och transportbransch",
          "address": {
            "@type": "PostalAddress",
            "addressLocality": "Stockholm",
            "addressCountry": "SE"
          },
          "sameAs": [
            "https://www.linkedin.com/company/baerell/"
          ]
        },
        {
          "@type": "SoftwareApplication",
          "@id": "https://taxiadministration.se/#software",
          "name": "Taxi Administration",
          "description": "Automatiserad lönehantering och bokföring för taxiåkerier i Sverige. Importera kördata från Bolt, Uber, Taxi Stockholm och andra plattformar.",
          "applicationCategory": "BusinessApplication",
          "applicationSubCategory": "Accounting Software",
          "operatingSystem": "Web Browser",
          "browserRequirements": "Requires JavaScript. Requires HTML5.",
          "url": "https://app.taxiadministration.se",
          "downloadUrl": "https://app.taxiadministration.se/login",
          "screenshot": [
            {
              "@type": "ImageObject",
              "url": "https://taxiadministration.se/salaryReport.png",
              "caption": "Lönerapport för taxiförare"
            },
            {
              "@type": "ImageObject",
              "url": "https://taxiadministration.se/driverReport.png",
              "caption": "Förarrapport med körstatistik"
            }
          ],
          "offers": {
            "@type": "AggregateOffer",
            "lowPrice": "0",
            "highPrice": "499",
            "priceCurrency": "SEK",
            "offerCount": "3",
            "availability": "https://schema.org/InStock"
          },
          "featureList": [
            "Automatiska löneberäkningar",
            "Import från Uber, Bolt, Taxi Stockholm",
            "PDF-rapporter och lönespecifikationer",
            "Excel-export",
            "Semesterersättning och OB-tillägg",
            "Flerspråkigt stöd (svenska, engelska, arabiska, persiska, somaliska)",
            "Molnbaserat - ingen installation krävs"
          ],
          "softwareVersion": "2.0",
          "releaseNotes": "https://taxiadministration.se/blog",
          "creator": {
            "@id": "https://taxiadministration.se/#organization"
          },
          "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "25",
            "bestRating": "5",
            "worstRating": "1"
          }
        },
        {
          "@type": "WebSite",
          "@id": "https://taxiadministration.se/#website",
          "url": "https://taxiadministration.se",
          "name": "Taxi Administration",
          "publisher": {
            "@id": "https://taxiadministration.se/#organization"
          },
          "inLanguage": "${currentLocale}"
        }
      ]
    }`} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:locale" content={currentLocale.replace('-', '_')} />
    {lang !== 'sv' && <meta property="og:locale:alternate" content="sv_SE" />}
    {lang !== 'en' && <meta property="og:locale:alternate" content="en_US" />}
    {lang !== 'ar' && <meta property="og:locale:alternate" content="ar_SA" />}
    {lang !== 'fa' && <meta property="og:locale:alternate" content="fa_IR" />}
    {lang !== 'so' && <meta property="og:locale:alternate" content="so_SO" />}
    <meta property="og:image" content="https://taxiadministration.se/og-image.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="Taxi Administration" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content="https://taxiadministration.se/og-image.png" />

    <!-- Additional head content (for structured data etc) -->
    <slot name="head" />
  </head>
  <body class="min-h-screen flex flex-col">
    <a href="#main-content" class="skip-link">Hoppa till innehåll</a>
    <Header />
    <main id="main-content" class="flex-grow">
      <slot />
    </main>
    <Footer />
    
    <!-- Intersection Observer for animations on scroll -->
    <script>
      document.addEventListener('astro:page-load', () => {
        const animatedElements = document.querySelectorAll('.animate-on-scroll');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('animated');
              observer.unobserve(entry.target);
            }
          });
        }, { threshold: 0.1 });
        
        animatedElements.forEach(element => {
          observer.observe(element);
        });
      });
    </script>
  </body>
</html>
